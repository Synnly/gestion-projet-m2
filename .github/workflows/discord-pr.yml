name: Notify Discord on PR open

on:
    pull_request:
        types: [opened, reopened, ready_for_review]
        branches: [dev]

jobs:
    notify:
        runs-on: ubuntu-latest
        steps:
            - name: Post PR info to Discord
              env:
                  WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
                  PR_NUMBER: ${{ github.event.pull_request.number }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
                  PR_BODY: ${{ github.event.pull_request.body }}
                  REPO: ${{ github.repository }}
                  BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
                  HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
              shell: bash
              run: |
                python3 - <<'PY'
                import json, os, sys, time, urllib.request, urllib.error
            
                def post(payload):
                    data = json.dumps(payload).encode("utf-8")
                    req = urllib.request.Request(
                        os.environ["WEBHOOK_URL"],
                        data=data,
                        headers={"Content-Type": "application/json"},
                        method="POST",
                    )
                    try:
                        with urllib.request.urlopen(req, timeout=10) as resp:
                            return resp.getcode(), resp.read().decode("utf-8","ignore")
                    except urllib.error.HTTPError as e:
                        body = e.read().decode("utf-8","ignore")
                        return e.code, body
                    except Exception as e:
                        return None, str(e)
            
                # ------ construit un payload minimal (content seul) ------
                content = f"**{os.environ.get('PR_AUTHOR','')}** a ouvert une pull request"
                if len(content) > 1900: content = content[:1900] + "…"
                status, body = post({"content": content, "allowed_mentions": {"parse": []}})
                print("Tentative content seul ->", status, body)
            
                if status and 200 <= status < 300:
                    sys.exit(0)
            
                # ------ si ok d'envoyer des embeds, on tente l'embed complet ------
                pr_title = os.environ.get("PR_TITLE","")
                if len(pr_title) > 250: pr_title = pr_title[:250] + "…"
                pr_body = (os.environ.get("PR_BODY") or "").strip()
                if len(pr_body) > 4000: pr_body = pr_body[:4000] + "…"
            
                embed = {
                    "title": f"PR #{os.environ.get('PR_NUMBER','')}: {pr_title}",
                    "url": os.environ.get("PR_URL",""),
                    "description": pr_body or "_(aucune description)_",
                    "fields": [
                        {"name": "Auteur", "value": os.environ.get("PR_AUTHOR","—"), "inline": True},
                        {"name": "Repo", "value": os.environ.get("REPO","—"), "inline": True},
                        {"name": "Branches", "value": f"`{os.environ.get('HEAD_BRANCH','')}` → `{os.environ.get('BASE_BRANCH','')}`", "inline": False},
                    ],
                }
                status2, body2 = post({
                    "content": content,
                    "allowed_mentions": {"parse": []},
                    "embeds": [embed],
                })
                print("Tentative avec embed ->", status2, body2)
            
                sys.exit(0 if (status2 and 200 <= status2 < 300) else 1)
                PY
